<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>The Anatomy of a Recommendation Engine - LightQuanta</title>

    <!-- Pinterest Verification Tag -->
    <meta name="p:domain_verify" content="78649e3c96104d254c14a2009100fcaf" />
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="http://sanghan.me/img/hv.png" rel="icon">

<link rel="canonical" href="http://sanghan.me/blog/2015/05/recommendation_engine/">

        <meta name="author" content="Sang Han" />
        <meta name="keywords" content="Machine Learning,Python,Math" />
        <meta name="description" content="A recommendation engine is a software system that analyzes large amounts of transactional data and distills personal profiles to present its users with relevant products/information/content. We see them in a wide variety of domains and applications and they help us navigate the overwhelming choice that we face everyday. This tutorial will formally introduce the concepts and definitions of the recommendation systems literature and will quickly move on to an iterative process for building a minimal reco engine. Recommenders have been around since at least 1992. Today we see different flavours of recommenders, deployed across different verticals: Amazon Netflix ..." />

        <meta property="og:site_name" content="LightQuanta" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="The Anatomy of a Recommendation Engine"/>
        <meta property="og:url" content="http://sanghan.me/blog/2015/05/recommendation_engine/"/>
        <meta property="og:description" content="A recommendation engine is a software system that analyzes large amounts of transactional data and distills personal profiles to present its users with relevant products/information/content. We see them in a wide variety of domains and applications and they help us navigate the overwhelming choice that we face everyday. This tutorial will formally introduce the concepts and definitions of the recommendation systems literature and will quickly move on to an iterative process for building a minimal reco engine. Recommenders have been around since at least 1992. Today we see different flavours of recommenders, deployed across different verticals: Amazon Netflix ..."/>
        <meta property="article:published_time" content="2015-05-27" />
            <meta property="article:section" content="Articles" />
            <meta property="article:tag" content="Machine Learning" />
            <meta property="article:tag" content="Python" />
            <meta property="article:tag" content="Math" />
            <meta property="article:author" content="Sang Han" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://sanghan.me/theme/css/bootstrap.paper.min.css" type="text/css"/>
    <link href="http://sanghan.me/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://sanghan.me/theme/css/pygments/solarizedlight.css" rel="stylesheet">
        <link href="http://sanghan.me/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="http://sanghan.me/theme/css/style.css" type="text/css"/>
        <link href="http://sanghan.me/static/css/site.css" rel="stylesheet">

        <link href="http://sanghan.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="LightQuanta ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top headroom" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://sanghan.me/" class="navbar-brand">

                <span class="fa-stack fa-large">
                    <i class="fa fa-square-o fa-stack-2x"></i>
                    <i class="fa fa-flask pull-center fa-stack-1x"></i>
                </span>
                LightQuanta
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li><a href="http://sanghan.me/pages/about.html">
                        <i class="fa fa-beer"></i>
                        <span class="icon-label">About&nbsp;Me</span></a></li>
                        <li><a href="http://sanghan.me/pages/projects.html">
                        <i class="fa fa-code"></i>
                        <span class="icon-label">Projects</span></a></li>
                        <li><a href="http://sanghan.me/pages/skills.html">
                        <i class="fa fa-graduation-cap"></i>
                        <span class="icon-label">Skills</span></a></li>
                        <li><a href="http://sanghan.me/pages/tools.html">
                        <i class="fa fa-wrench"></i>
                        <span class="icon-label">Tools</span></a></li>
            <ul class="nav navbar-nav navbar-right">
                <!--Dropdown Categories-->
                    <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">Categories<b class="caret"></b></a>
                    <ul class="dropdown-menu" role="menu">
                        <li  class="active" >
                        <a href="http://sanghan.me/category/articles.html">Articles</a></li>
                        <li >
                        <a href="http://sanghan.me/category/programming.html">Programming</a></li>
                        <li >
                        <a href="http://sanghan.me/category/quotes.html">Quotes</a></li>
                        <li >
                        <a href="http://sanghan.me/category/tumblr.html">Tumblr</a></li>
                    </ul>
                    </li>

<!-- Disabled
<ul class="nav navbar-nav navbar-right">
    <li><a href="http://sanghan.me/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
</ul>
-->



        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->


<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
            <ol class="breadcrumb">
                <li><a href="http://sanghan.me" title="LightQuanta"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="http://sanghan.me/category/articles.html" title="Articles">Articles</a></li>
                <li class="active">The Anatomy of a Recommendation&nbsp;Engine</li>
            </ol>

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://sanghan.me/blog/2015/05/recommendation_engine/"
                       rel="bookmark"
                       title="Permalink to The Anatomy of a Recommendation Engine">
                        The Anatomy of a Recommendation&nbsp;Engine
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-primary">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-05-27T00:00:00-07:00"> Wed, 27 May 2015</time>
    </span>

        <span class="label label-success">Category</span>
        <a href="http://sanghan.me/category/articles.html">Articles</a>


<span class="label label-info">Tags</span>
	<a href="http://sanghan.me/tag/machine-learning.html">Machine Learning</a>
        /
	<a href="http://sanghan.me/tag/python.html">Python</a>
        /
	<a href="http://sanghan.me/tag/math.html">Math</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>A recommendation engine is a software system that analyzes large amounts of
transactional data and distills personal profiles to present its users with
relevant&nbsp;products/information/content.</p>
<p>We see them in a wide variety of domains and applications and
they help us navigate the overwhelming choice that we face&nbsp;everyday.</p>
<p>This tutorial will formally introduce the concepts and definitions of the
recommendation systems literature and will quickly move on to an iterative process for building a minimal reco&nbsp;engine.</p>
<p><img alt="Recommendation Graph" src="http://sanghan.me/img/recommendation.png" /></p>
<p>Recommenders have been around since at least 1992. Today we see
different flavours of recommenders, deployed across different&nbsp;verticals:</p>
<ul class="simple">
<li>Amazon</li>
<li>Netflix</li>
<li>Facebook</li>
<li>Last.fm.</li>
</ul>
<p>What exactly do they&nbsp;do?</p>
<div class="section" id="definitions-from-the-literature">
<h2>Definitions from the&nbsp;literature</h2>
<ul class="simple">
<li><em>In a typical recommender system people provide recommendations as
inputs, which the system then aggregates and directs to appropriate
recipients.</em> &#8212; Resnick and Varian,&nbsp;1997</li>
<li><em>Collaborative filtering simply means that people collaborate to help
one another perform filtering by recording their reactions to
documents they read.</em> &#8212; Goldberg et al,&nbsp;1992</li>
<li><em>In its most common formulation, the recommendation problem is
reduced to the problem of estimating ratings for the items that have
not been seen by a user. Intuitively, this estimation is usually
based on the ratings given by this user to other items and on some
other information [&#8230;] Once we can estimate ratings for the yet
unrated items, we can recommend to the user the item(s) with the
highest estimated rating(s).</em> &#8212; Adomavicius and Tuzhilin,&nbsp;2005</li>
<li><em>Driven by computer algorithms, recommenders help consumers by
selecting products they will probably like and might buy based on
their browsing, searches, purchases, and preferences.</em> &#8212; Konstan and
Riedl,&nbsp;2012</li>
</ul>
</div>
<div class="section" id="notation">
<h2>Notation</h2>
<ul class="simple">
<li><span class="math">\(U\)</span> is the set of users in our domain. Its size is <span class="math">\(|U|\)</span>.</li>
<li><span class="math">\(I\)</span> is the set of items in our domain. Its size is <span class="math">\(|I|\)</span>.</li>
<li><span class="math">\(I(u)\)</span> is the set of items that user <span class="math">\(u\)</span> has&nbsp;rated.</li>
<li><span class="math">\(-I(u)\)</span> is the complement of <span class="math">\(I(u)\)</span> i.e., the set of
items not yet seen by user <span class="math">\(u\)</span>.</li>
<li><span class="math">\(U(i)\)</span> is the set of users that have rated item <span class="math">\(i\)</span>.</li>
<li><span class="math">\(-U(i)\)</span> is the complement of <span class="math">\(U(i)\)</span>.</li>
<li><span class="math">\(S(u,i)\)</span> is a function that measures the utility of item
<span class="math">\(i\)</span> for user <span class="math">\(u\)</span>.</li>
</ul>
</div>
<div class="section" id="goal-of-a-recommendation-system">
<h2>Goal of a recommendation&nbsp;system</h2>
<div class="math">
\begin{equation*}
i^{*} = argmax_{i \in -I(u)} S(u,i), \forall{u \in U}
\end{equation*}
</div>
</div>
<div class="section" id="problem-statement">
<h2>Problem&nbsp;statement</h2>
<p>The recommendation problem in its most basic form is quite simple to&nbsp;define:</p>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">user_id, movie_id</th>
<th class="head">m_1</th>
<th class="head">m_2</th>
<th class="head">m_3</th>
<th class="head">m_4</th>
<th class="head">m_5</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>u_1</td>
<td>?</td>
<td>?</td>
<td>4</td>
<td>?</td>
<td>1</td>
</tr>
<tr><td>u_2</td>
<td>3</td>
<td>?</td>
<td>?</td>
<td>2</td>
<td>2</td>
</tr>
<tr><td>u_3</td>
<td>3</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>?</td>
</tr>
<tr><td>u_4</td>
<td>?</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr><td>u_5</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>?</td>
</tr>
<tr><td>u_6</td>
<td>2</td>
<td>?</td>
<td>2</td>
<td>?</td>
<td>?</td>
</tr>
<tr><td>u_7</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>?</td>
</tr>
<tr><td>u_8</td>
<td>3</td>
<td>1</td>
<td>5</td>
<td>?</td>
<td>?</td>
</tr>
<tr><td>u_9</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Given a partially filled matrix of&nbsp;ratings</p>
<div class="math">
\begin{equation*}
|U|x|I|
\end{equation*}
</div>
<p>Estimate the missing&nbsp;values.</p>
<div class="section" id="pandas-a-python-data-analysis-library">
<h3>pandas: A Python Data Analysis&nbsp;Library</h3>
</div>
</div>
<div class="section" id="what-is-it">
<h2>What is&nbsp;it?</h2>
<p><em>Python has long been great for data munging and preparation, but less
so for data analysis and modeling. pandas helps fill this gap, enabling
you to carry out your entire data analysis workflow in Python without
having to switch to a more domain specific language like&nbsp;R.</em></p>
<p>The heart of pandas is the DataFrame object for data manipulation. It&nbsp;features:</p>
<ul class="simple">
<li>a powerful index&nbsp;object</li>
<li>data&nbsp;alignment</li>
<li>handling of missing&nbsp;data</li>
<li>aggregation with&nbsp;groupby</li>
<li>data manipuation via reshape, pivot, slice, merge,&nbsp;join</li>
</ul>
<div class="highlight"><pre><span id="line-1"><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span id="line-2"><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
</span><span id="line-3">
</span><span id="line-4"><span class="c"># set some print options</span>
</span><span id="line-5"><span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="line-6"><span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="line-7"><span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span id="line-8"><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">&#39;precision&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;notebook_repr_html&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="p">)</span>
</span><span id="line-9">
</span><span id="line-10"><span class="c"># init random gen</span>
</span><span id="line-11"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="kn">import</span> <span class="nn">os</span>
</span><span id="line-2"><span class="kn">import</span> <span class="nn">shutil</span>
</span><span id="line-3"><span class="kn">import</span> <span class="nn">zipfile</span>
</span><span id="line-4">
</span><span id="line-5"><span class="k">try</span><span class="p">:</span>
</span><span id="line-6">    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlretrieve</span>
</span><span id="line-7"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="line-8">    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlretrieve</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
</span><span id="line-2">    <span class="n">filename</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="line-3">    <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="line-4">
</span><span id="line-5">    <span class="n">compressed</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="line-6">    <span class="n">compressed</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">filename</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compressed</span><span class="o">.</span><span class="n">infolist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">)])</span>
</span><span id="line-7">    <span class="n">compressed</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="line-8">
</span><span id="line-9">    <span class="n">folder</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;.zip&#39;</span><span class="p">)</span>
</span><span id="line-10">    <span class="n">os</span><span class="o">.</span><span class="n">renames</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s">&#39;/data&#39;</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">)</span>
</span><span id="line-11">    <span class="n">os</span><span class="o">.</span><span class="n">renames</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s">&#39;/exports&#39;</span><span class="p">,</span> <span class="s">&#39;exports&#39;</span><span class="p">)</span>
</span><span id="line-12">
</span><span id="line-13">    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="line-14">    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="n">uri</span> <span class="o">=</span> <span class="s">&quot;http://unatainc.github.io/pycon2015/data/pycon2015_tutorial322.zip&quot;</span>
</span><span id="line-2">
</span><span id="line-3"><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;data/ml-1m&#39;</span><span class="p">):</span>
</span><span id="line-4">    <span class="n">get_dataset</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span></pre></div>
<div class="section" id="the-movielens-dataset-loading-and-first-look">
<h3>The MovieLens dataset: loading and first&nbsp;look</h3>
<p>MovieLens from GroupLens Research: [grouplens.org](<a class="reference external" href="http://www.grouplens.org/">http://www.grouplens.org/</a>)</p>
<p>The MovieLens 1M data set contains 1 million ratings collected from 6000 users
on 4000&nbsp;movies.</p>
<p>The MovieLens data is spread across three files. We&#8217;ll load each file
using the <tt class="docutils literal">pd.read_table</tt> function:</p>
<div class="highlight"><pre><span id="line-1"><span class="n">users</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s">&#39;data/ml-1m/users.dat&#39;</span><span class="p">,</span>
</span><span id="line-2">                      <span class="n">sep</span><span class="o">=</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
</span><span id="line-3">                      <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="s">&#39;gender&#39;</span><span class="p">,</span> <span class="s">&#39;age&#39;</span><span class="p">,</span> <span class="s">&#39;occupation&#39;</span><span class="p">,</span> <span class="s">&#39;zip&#39;</span><span class="p">])</span>
</span><span id="line-4">
</span><span id="line-5"><span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s">&#39;data/ml-1m/ratings.dat&#39;</span><span class="p">,</span>
</span><span id="line-6">                        <span class="n">sep</span><span class="o">=</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
</span><span id="line-7">                        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="s">&#39;movie_id&#39;</span><span class="p">,</span> <span class="s">&#39;rating&#39;</span><span class="p">,</span> <span class="s">&#39;timestamp&#39;</span><span class="p">])</span>
</span><span id="line-8">
</span><span id="line-9"><span class="n">movies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s">&#39;data/ml-1m/movies.dat&#39;</span><span class="p">,</span>
</span><span id="line-10">                       <span class="n">sep</span><span class="o">=</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
</span><span id="line-11">                       <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;movie_id&#39;</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;genres&#39;</span><span class="p">])</span>
</span><span id="line-12">
</span><span id="line-13"><span class="c"># show how one of them looks</span>
</span><span id="line-14">
</span><span id="line-15"><span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></pre></div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>movie_id</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td> 1</td>
      <td> 1193</td>
      <td> 5</td>
      <td> 978300760</td>
    </tr>
    <tr>
      <th>1</th>
      <td> 1</td>
      <td>  661</td>
      <td> 3</td>
      <td> 978302109</td>
    </tr>
    <tr>
      <th>2</th>
      <td> 1</td>
      <td>  914</td>
      <td> 3</td>
      <td> 978301968</td>
    </tr>
    <tr>
      <th>3</th>
      <td> 1</td>
      <td> 3408</td>
      <td> 4</td>
      <td> 978300275</td>
    </tr>
    <tr>
      <th>4</th>
      <td> 1</td>
      <td> 2355</td>
      <td> 5</td>
      <td> 978824291</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 4&nbsp;columns</p>
</div><p>Using <tt class="docutils literal">pd.merge</tt> we get it all into one big&nbsp;DataFrame.</p>
<div class="highlight"><pre><span id="line-1"><span class="n">movielens</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">users</span><span class="p">),</span> <span class="n">movies</span><span class="p">)</span>
</span><span id="line-2"><span class="n">movielens</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></pre></div>
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>movie_id</th>
      <th>rating</th>
      <th>timestamp</th>
      <th>gender</th>
      <th>age</th>
      <th>occupation</th>
      <th>zip</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>  1</td>
      <td> 1193</td>
      <td> 5</td>
      <td> 978300760</td>
      <td> F</td>
      <td>  1</td>
      <td> 10</td>
      <td> 48067</td>
      <td> One Flew Over the Cuckoo&#8217;s Nest (1975)</td>
      <td> Drama</td>
    </tr>
    <tr>
      <th>1</th>
      <td>  2</td>
      <td> 1193</td>
      <td> 5</td>
      <td> 978298413</td>
      <td> M</td>
      <td> 56</td>
      <td> 16</td>
      <td> 70072</td>
      <td> One Flew Over the Cuckoo&#8217;s Nest (1975)</td>
      <td> Drama</td>
    </tr>
    <tr>
      <th>2</th>
      <td> 12</td>
      <td> 1193</td>
      <td> 4</td>
      <td> 978220179</td>
      <td> M</td>
      <td> 25</td>
      <td> 12</td>
      <td> 32793</td>
      <td> One Flew Over the Cuckoo&#8217;s Nest (1975)</td>
      <td> Drama</td>
    </tr>
    <tr>
      <th>3</th>
      <td> 15</td>
      <td> 1193</td>
      <td> 4</td>
      <td> 978199279</td>
      <td> M</td>
      <td> 25</td>
      <td>  7</td>
      <td> 22903</td>
      <td> One Flew Over the Cuckoo&#8217;s Nest (1975)</td>
      <td> Drama</td>
    </tr>
    <tr>
      <th>4</th>
      <td> 17</td>
      <td> 1193</td>
      <td> 5</td>
      <td> 978158471</td>
      <td> M</td>
      <td> 50</td>
      <td>  1</td>
      <td> 95350</td>
      <td> One Flew Over the Cuckoo&#8217;s Nest (1975)</td>
      <td> Drama</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 10&nbsp;columns</p>
</div></div>
<div class="section" id="challenge-prep-evaluation-mechanism">
<h3>Challenge prep: evaluation&nbsp;mechanism</h3>
<p>Before we start building our minimal reco engine we need a basic
mechanism to evaluate the performance of our engine. For that we&nbsp;will:</p>
<ul class="simple">
<li>split the data into train and test&nbsp;sets</li>
<li>introduce a performance&nbsp;criterion</li>
<li>write an <tt class="docutils literal">evaluate</tt> function.</li>
</ul>
</div>
</div>
<div class="section" id="evaluation-split-ratings-into-train-and-test-sets">
<h2>Evaluation: split ratings into train and test&nbsp;sets</h2>
<p>This subsection will generate training and testing sets for evaluation.
You do not need to understand every single line of code, just the
general&nbsp;gist:</p>
<ul class="simple">
<li>take a smaller sample from the full 1M dataset for speed&nbsp;reasons;</li>
<li>make sure that we have at least 2 ratings per user in that&nbsp;subset;</li>
<li>split the result into training and testing&nbsp;sets.</li>
</ul>
<div class="highlight"><pre><span id="line-1"><span class="c"># let&#39;s work with a smaller subset for speed reasons</span>
</span><span id="line-2"><span class="n">movielens</span> <span class="o">=</span> <span class="n">movielens</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">movielens</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)]</span>
</span><span id="line-3"><span class="k">print</span> <span class="n">movielens</span><span class="o">.</span><span class="n">shape</span>
</span><span id="line-4"><span class="k">print</span> <span class="n">movielens</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</span><span id="line-5"><span class="k">print</span> <span class="n">movielens</span><span class="o">.</span><span class="n">movie_id</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="line-2"><span class="mi">3698</span>
</span><span id="line-3"><span class="mi">2275</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="n">user_ids_larger_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">movielens</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="line-2"><span class="n">user_ids_larger_1</span> <span class="o">=</span> <span class="n">user_ids_larger_1</span><span class="p">[</span><span class="n">user_ids_larger_1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
</span><span id="line-3">
</span><span id="line-4"><span class="n">movielens</span> <span class="o">=</span> <span class="n">movielens</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">movielens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s">&#39;user_id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">user_ids_larger_1</span><span class="p">)</span>
</span><span id="line-5"><span class="k">print</span> <span class="n">movielens</span><span class="o">.</span><span class="n">shape</span>
</span><span id="line-6"><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">movielens</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="p">(</span><span class="mi">8442</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></pre></div>
<p>We now generate train and test subsets by marking 20% of each users&#8217;s
ratings, using groupby and&nbsp;apply.</p>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">assign_to_set</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span><span id="line-2">    <span class="n">sampled_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
</span><span id="line-3">                                   <span class="n">size</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">)),</span>
</span><span id="line-4">                                   <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span id="line-5">    <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">sampled_ids</span><span class="p">,</span> <span class="s">&#39;for_testing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</span><span id="line-6">    <span class="k">return</span> <span class="n">df</span>
</span><span id="line-7">
</span><span id="line-8"><span class="n">movielens</span><span class="p">[</span><span class="s">&#39;for_testing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
</span><span id="line-9"><span class="n">grouped</span> <span class="o">=</span> <span class="n">movielens</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">assign_to_set</span><span class="p">)</span>
</span><span id="line-10"><span class="n">movielens_train</span> <span class="o">=</span> <span class="n">movielens</span><span class="p">[</span><span class="n">grouped</span><span class="o">.</span><span class="n">for_testing</span> <span class="o">==</span> <span class="bp">False</span><span class="p">]</span>
</span><span id="line-11"><span class="n">movielens_test</span> <span class="o">=</span> <span class="n">movielens</span><span class="p">[</span><span class="n">grouped</span><span class="o">.</span><span class="n">for_testing</span> <span class="o">==</span> <span class="bp">True</span><span class="p">]</span>
</span><span id="line-12"><span class="k">print</span> <span class="n">movielens</span><span class="o">.</span><span class="n">shape</span>
</span><span id="line-13"><span class="k">print</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">shape</span>
</span><span id="line-14"><span class="k">print</span> <span class="n">movielens_test</span><span class="o">.</span><span class="n">shape</span>
</span><span id="line-15"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">movielens_train</span><span class="o">.</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">movielens_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="p">(</span><span class="mi">8442</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
</span><span id="line-2"><span class="p">(</span><span class="mi">5801</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
</span><span id="line-3"><span class="p">(</span><span class="mi">2641</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
</span></pre></div>
<p>Store these two sets in text&nbsp;files:</p>
<div class="highlight"><pre><span id="line-1"><span class="n">movielens_train</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">&#39;data/my_generated_movielens_train.csv&#39;</span><span class="p">)</span>
</span><span id="line-2"><span class="n">movielens_test</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">&#39;data/my_generated_movielens_test.csv&#39;</span><span class="p">)</span>
</span></pre></div>
</div>
<div class="section" id="evaluation-performance-criterion">
<h2>Evaluation: performance&nbsp;criterion</h2>
<p>Performance evaluation of recommendation systems is an entire topic all
in itself. Some of the options&nbsp;include:</p>
<ul class="simple">
<li><span class="caps">RMSE</span>: <span class="math">\(\sqrt{\frac{\sum(\hat y -&nbsp;y)^2}{n}}\)</span></li>
<li>Precision / Recall /&nbsp;F-scores</li>
<li><span class="caps">ROC</span>&nbsp;curves</li>
<li>Cost&nbsp;curves</li>
</ul>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">compute_rmse</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">):</span>
</span><span id="line-2">    <span class="sd">&quot;&quot;&quot; Compute Root Mean Squared Error. &quot;&quot;&quot;</span>
</span><span id="line-3">
</span><span id="line-4">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
</span></pre></div>
</div>
<div class="section" id="evaluation-the-evaluate-method">
<h2>Evaluation: the &#8216;evaluate&#8217;&nbsp;method</h2>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">estimate_f</span><span class="p">):</span>
</span><span id="line-2">    <span class="sd">&quot;&quot;&quot; RMSE-based predictive performance evaluation with pandas. &quot;&quot;&quot;</span>
</span><span id="line-3">
</span><span id="line-4">    <span class="n">ids_to_estimate</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">movielens_test</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movielens_test</span><span class="o">.</span><span class="n">movie_id</span><span class="p">)</span>
</span><span id="line-5">    <span class="n">estimated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">estimate_f</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ids_to_estimate</span><span class="p">])</span>
</span><span id="line-6">    <span class="n">real</span> <span class="o">=</span> <span class="n">movielens_test</span><span class="o">.</span><span class="n">rating</span><span class="o">.</span><span class="n">values</span>
</span><span id="line-7">    <span class="k">return</span> <span class="n">compute_rmse</span><span class="p">(</span><span class="n">estimated</span><span class="p">,</span> <span class="n">real</span><span class="p">)</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">my_estimate_function</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">):</span>
</span><span id="line-2">    <span class="k">return</span> <span class="mi">3</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="k">print</span> <span class="s">&#39;RMSE for my estimate function: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">my_estimate_function</span><span class="p">)</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="n">RMSE</span> <span class="k">for</span> <span class="n">my</span> <span class="n">estimate</span> <span class="n">function</span><span class="p">:</span> <span class="mf">1.25716424791</span>
</span></pre></div>
<p>&#8212;&gt; Go to &quot;Mini Challenge prep: data loading <span class="amp">&amp;</span> evaluation&nbsp;functions&quot;</p>
<div class="section" id="well-known-solutions-to-the-recommendation-problem">
<h3>Well-known Solutions to the Recommendation&nbsp;Problem</h3>
</div>
</div>
<div class="section" id="content-based-filtering">
<h2>Content-based&nbsp;filtering</h2>
<p><em>Recommend based on the user&#8217;s rating&nbsp;history.</em></p>
<p>Generic expression (notice how this is kind of a &#8216;row-based&#8217;&nbsp;approach):</p>
<div class="math">
\begin{equation*}
\newcommand{\aggr}{\mathop{\rm aggr}\nolimits}
r_{u,i} = \aggr_{i' \in I(u)} [r_{u,i'}]
\end{equation*}
</div>
<p>A simple example using the mean as an aggregation&nbsp;function:</p>
<div class="math">
\begin{equation*}
r_{u,i} = \bar r_u = \frac{\sum_{i' \in I(u)} r_{u,i'}}{|I(u)|}
\end{equation*}
</div>
</div>
<div class="section" id="collaborative-filtering">
<h2>Collaborative&nbsp;filtering</h2>
<p><em>Recommend based on other user&#8217;s rating&nbsp;histories.</em></p>
<p>Generic expression (notice how this is kind of a &#8216;col-based&#8217;&nbsp;approach):</p>
<div class="math">
\begin{equation*}
\newcommand{\aggr}{\mathop{\rm aggr}\nolimits}
r_{u,i} = \aggr_{u' \in U(i)} [r_{u',i}]
\end{equation*}
</div>
<p>A simple example using the mean as an aggregation&nbsp;function:</p>
<div class="math">
\begin{equation*}
r_{u,i} = \bar r_i = \frac{\sum_{u' \in U(i)} r_{u',i}}{|U(i)|}
\end{equation*}
</div>
</div>
<div class="section" id="hybrid-solutions">
<h2>Hybrid&nbsp;solutions</h2>
<p>The literature has lots of examples of systems that try to combine the
strengths of the two main approaches. This can be done in a number of&nbsp;ways:</p>
<ul class="simple">
<li>Combine the predictions of a content-based system and a collaborative&nbsp;system.</li>
<li>Incorporate content-based techniques into a collaborative&nbsp;approach.</li>
<li>Incorporarte collaborative techniques into a content-based&nbsp;approach.</li>
<li>Unifying&nbsp;model.</li>
</ul>
</div>
<div class="section" id="availability-of-item-metadata">
<h2>Availability of item&nbsp;metadata</h2>
<p>Content-based techniques are limited by the amount of metadata that is
available to describe an item. There are domains in which feature
extraction methods are expensive or time consuming, e.g., processing
multimedia data such as graphics, audio/video streams. In the context of
grocery items for example, it&#8217;s often the case that item information is
only partial or completely missing. Examples&nbsp;include:</p>
<ul class="simple">
<li>Ingredients</li>
<li>Nutrition&nbsp;facts</li>
<li>Brand</li>
<li>Description</li>
<li>County of&nbsp;origin</li>
</ul>
</div>
<div class="section" id="new-user-problem">
<h2>New user&nbsp;problem</h2>
<p>A user has to have rated a sufficient number of items before a
recommender system can have a good idea of what their preferences are.
In a content-based system, the aggregation function needs ratings to&nbsp;aggregate.</p>
</div>
<div class="section" id="new-item-problem">
<h2>New item&nbsp;problem</h2>
<p>Collaborative filters rely on an item being rated by many users to
compute aggregates of those ratings. Think of this as the exact
counterpart of the new user problem for content-based&nbsp;systems.</p>
</div>
<div class="section" id="data-sparsity">
<h2>Data&nbsp;sparsity</h2>
<p>When looking at the more general versions of content-based and
collaborative systems, the success of the recommender system depends on
the availability of a critical mass of user/item iteractions. We get a
first glance at the data sparsity problem by quantifying the ratio of
existing ratings vs <span class="math">\(|U|x|I|\)</span>. A highly sparse matrix of
interactions makes it difficult to compute similarities between users
and items. As an example, for a user whose tastes are unusual compared
to the rest of the population, there will not be any other users who are
particularly similar, leading to poor&nbsp;recommendations.</p>
<div class="section" id="minimal-reco-engine-v1-0-simple-mean-ratings">
<h3>Minimal reco engine v1.0: simple mean&nbsp;ratings</h3>
</div>
</div>
<div class="section" id="content-based-filtering-using-mean-ratings">
<h2>Content-based filtering using mean&nbsp;ratings</h2>
<p>With this table-like representation of the ratings data, a basic
content-based filter becomes a one-liner&nbsp;function.</p>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">content_mean</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">):</span>
</span><span id="line-2">    <span class="sd">&quot;&quot;&quot; Simple content-filtering based on mean ratings. &quot;&quot;&quot;</span>
</span><span id="line-3">
</span><span id="line-4">    <span class="n">user_condition</span> <span class="o">=</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span>
</span><span id="line-5">    <span class="k">return</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">user_condition</span><span class="p">,</span> <span class="s">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="line-6">
</span><span id="line-7"><span class="k">print</span> <span class="s">&#39;RMSE for estimate1: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">content_mean</span><span class="p">)</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="n">RMSE</span> <span class="k">for</span> <span class="n">estimate1</span><span class="p">:</span> <span class="mf">1.26844670375</span>
</span></pre></div>
<p>&#8212;&gt; Go to &quot;Reco systems questions: Minimal reco engine&nbsp;v1.0&quot;</p>
<div class="section" id="more-formulas">
<h3>More&nbsp;formulas!</h3>
<p>Here are some basic ways in which we can generalize the simple
mean-based algorithms we discussed&nbsp;before.</p>
</div>
</div>
<div class="section" id="generalizations-of-the-aggregation-function-for-content-based-filtering-incorporating-similarities">
<h2>Generalizations of the aggregation function for content-based filtering: incorporating&nbsp;similarities</h2>
<p>Possibly incorporating metadata about items, which makes the term
&#8216;content&#8217; make more sense&nbsp;now.</p>
<div class="math">
\begin{equation*}
r_{u,i} = k \sum_{i' \in I(u)} sim(i, i') \; r_{u,i'}
\end{equation*}
</div>
<div class="math">
\begin{equation*}
r_{u,i} = \bar r_u + k \sum_{i' \in I(u)} sim(i, i') \; (r_{u,i'} - \bar r_u)
\end{equation*}
</div>
<p>Here <span class="math">\(k\)</span> is a normalizing&nbsp;factor,</p>
<div class="math">
\begin{equation*}
k = \frac{1}{\sum_{i' \in I(u)} |sim(i,i')|}
\end{equation*}
</div>
<p>and <span class="math">\(\bar r_u\)</span> is the average rating of user&nbsp;u:</p>
<div class="math">
\begin{equation*}
\bar r_u = \frac{\sum_{i \in I(u)} r_{u,i}}{|I(u)|}
\end{equation*}
</div>
</div>
<div class="section" id="generalizations-of-the-aggregation-function-for-collaborative-filtering-incorporating-similarities">
<h2>Generalizations of the aggregation function for collaborative filtering: incorporating&nbsp;similarities</h2>
<p>Possibly incorporating metadata about&nbsp;users.</p>
<div class="math">
\begin{equation*}
r_{u,i} = k \sum_{u' \in U(i)} sim(u, u') \; r_{u',i}
\end{equation*}
</div>
<div class="math">
\begin{equation*}
r_{u,i} = \bar r_u + k \sum_{u' \in U(i)} sim(u, u') \; (r_{u',i} - \bar r_u)
\end{equation*}
</div>
<p>Here <span class="math">\(k\)</span> is a normalizing&nbsp;factor,</p>
<div class="math">
\begin{equation*}
k = \frac{1}{\sum_{u' \in U(i)} |sim(u,u')|}
\end{equation*}
</div>
<p>and <span class="math">\(\bar r_u\)</span> is the average rating of user&nbsp;u:</p>
<div class="math">
\begin{equation*}
\bar r_u = \frac{\sum_{i \in I(u)} r_{u,i}}{|I(u)|}
\end{equation*}
</div>
<div class="section" id="aggregation-in-pandas">
<h3>Aggregation in&nbsp;pandas</h3>
</div>
</div>
<div class="section" id="groupby">
<h2>Groupby</h2>
<p>The idea of groupby is that of <em>split-apply-combine</em>:</p>
<ul class="simple">
<li>split data in an object according to a given&nbsp;key;</li>
<li>apply a function to each&nbsp;subset;</li>
<li>combine results into a new&nbsp;object.</li>
</ul>
<div class="highlight"><pre><span id="line-1"><span class="n">movielens_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">&#39;gender&#39;</span><span class="p">)[</span><span class="s">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="n">gender</span>
</span><span id="line-2"><span class="n">F</span>         <span class="mf">3.59</span>
</span><span id="line-3"><span class="n">M</span>         <span class="mf">3.51</span>
</span><span id="line-4"><span class="n">Name</span><span class="p">:</span> <span class="n">rating</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="n">movielens_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">&#39;gender&#39;</span><span class="p">,</span> <span class="s">&#39;age&#39;</span><span class="p">])[</span><span class="s">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="n">gender</span>  <span class="n">age</span>
</span><span id="line-2"><span class="n">F</span>       <span class="mi">1</span>      <span class="mf">3.61</span>
</span><span id="line-3">        <span class="mi">18</span>     <span class="mf">3.43</span>
</span><span id="line-4">        <span class="mi">25</span>     <span class="mf">3.61</span>
</span><span id="line-5">        <span class="mi">35</span>     <span class="mf">3.65</span>
</span><span id="line-6">        <span class="mi">45</span>     <span class="mf">3.54</span>
</span><span id="line-7">        <span class="mi">50</span>     <span class="mf">3.67</span>
</span><span id="line-8">        <span class="mi">56</span>     <span class="mf">4.07</span>
</span><span id="line-9"><span class="n">M</span>       <span class="mi">1</span>      <span class="mf">3.38</span>
</span><span id="line-10">        <span class="mi">18</span>     <span class="mf">3.44</span>
</span><span id="line-11">        <span class="mi">25</span>     <span class="mf">3.43</span>
</span><span id="line-12">        <span class="mi">35</span>     <span class="mf">3.61</span>
</span><span id="line-13">        <span class="mi">45</span>     <span class="mf">3.55</span>
</span><span id="line-14">        <span class="mi">50</span>     <span class="mf">3.76</span>
</span><span id="line-15">        <span class="mi">56</span>     <span class="mf">3.70</span>
</span><span id="line-16"><span class="n">Name</span><span class="p">:</span> <span class="n">rating</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</span></pre></div>
</div>
<div class="section" id="pivoting">
<h2>Pivoting</h2>
<p>Let&#8217;s start with a simple pivoting example that does not involve any
aggregation. We can extract a ratings matrix as&nbsp;follows:</p>
<div class="highlight"><pre><span id="line-1"><span class="c"># transform the ratings frame into a ratings matrix</span>
</span><span id="line-2"><span class="n">ratings_mtx_df</span> <span class="o">=</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="s">&#39;rating&#39;</span><span class="p">,</span>
</span><span id="line-3">                                             <span class="n">index</span><span class="o">=</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span>
</span><span id="line-4">                                             <span class="n">columns</span><span class="o">=</span><span class="s">&#39;movie_id&#39;</span><span class="p">)</span>
</span></pre></div>
<div class="highlight"><pre><span id="line-1"><span class="c"># grab another subsquare of the ratings matrix to actually diplay some real entries!</span>
</span><span id="line-2"><span class="n">ratings_mtx_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1196</span><span class="p">:</span><span class="mi">1200</span><span class="p">]</span>
</span></pre></div>
<p>The more interesting case with <tt class="docutils literal">pivot_table</tt> is as an interface to
<tt class="docutils literal">groupby</tt>:</p>
<div class="highlight"><pre><span id="line-1"><span class="n">movielens_train</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="s">&#39;rating&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s">&#39;age&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s">&#39;gender&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s">&#39;mean&#39;</span><span class="p">)</span>
</span></pre></div>
<p>You can pass in a list of functions, such as <tt class="docutils literal">[np.mean, np.std]</tt>, to
compute mean ratings and a measure of&nbsp;disagreement.</p>
<div class="highlight"><pre><span id="line-1"><span class="n">movielens_train</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="s">&#39;rating&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s">&#39;age&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s">&#39;gender&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">])</span>
</span></pre></div>
<div class="section" id="minimal-reco-engine-v1-1-implicit-sim-functions">
<h3>Minimal reco engine v1.1: implicit sim&nbsp;functions</h3>
<p>We&#8217;re going to need a user index from the users portion of the dataset.
This will allow us to retrieve information given a specific user_id in
a more convenient&nbsp;way:</p>
<div class="highlight"><pre><span id="line-1"><span class="n">user_info</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">)</span>
</span><span id="line-2"><span class="n">user_info</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></pre></div>
<p>With this in hand, we can now ask what the gender of a particular
user_id is like&nbsp;so:</p>
<div class="highlight"><pre><span id="line-1"><span class="n">user_id</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="line-2"><span class="n">user_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">user_id</span><span class="p">,</span> <span class="s">&#39;gender&#39;</span><span class="p">]</span>
</span></pre></div>
</div>
</div>
<div class="section" id="collaborative-based-filtering-using-implicit-sim-functions">
<h2>Collaborative-based filtering using implicit sim&nbsp;functions</h2>
<p>Using the pandas aggregation framework we will build a collaborative
filter that estimates ratings using an implicit <tt class="docutils literal">sim(u,u')</tt> function
to compare different&nbsp;users.</p>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">collab_gender</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">):</span>
</span><span id="line-2">    <span class="sd">&quot;&quot;&quot; Collaborative filtering using an implicit sim(u,u&#39;) based on gender. &quot;&quot;&quot;</span>
</span><span id="line-3">
</span><span id="line-4">    <span class="n">user_condition</span> <span class="o">=</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">user_id</span>
</span><span id="line-5">    <span class="n">movie_condition</span> <span class="o">=</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">movie_id</span> <span class="o">==</span> <span class="n">movie_id</span>
</span><span id="line-6">    <span class="n">ratings_by_others</span> <span class="o">=</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">user_condition</span> <span class="o">&amp;</span> <span class="n">movie_condition</span><span class="p">]</span>
</span><span id="line-7">    <span class="k">if</span> <span class="n">ratings_by_others</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="line-8">        <span class="k">return</span> <span class="mf">3.0</span>
</span><span id="line-9">
</span><span id="line-10">    <span class="n">means_by_gender</span> <span class="o">=</span> <span class="n">ratings_by_others</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s">&#39;rating&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s">&#39;movie_id&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s">&#39;gender&#39;</span><span class="p">)</span>
</span><span id="line-11">    <span class="n">user_gender</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">user_id</span><span class="p">,</span> <span class="s">&#39;gender&#39;</span><span class="p">]</span>
</span><span id="line-12">    <span class="k">if</span> <span class="n">user_gender</span> <span class="ow">in</span> <span class="n">means_by_gender</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="line-13">        <span class="k">return</span> <span class="n">means_by_gender</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">movie_id</span><span class="p">,</span> <span class="n">user_gender</span><span class="p">]</span>
</span><span id="line-14">    <span class="k">else</span><span class="p">:</span>
</span><span id="line-15">        <span class="k">return</span> <span class="n">means_by_gender</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">movie_id</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="line-16">
</span><span id="line-17"><span class="k">print</span> <span class="s">&#39;RMSE for collab_gender: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">collab_gender</span><span class="p">)</span>
</span></pre></div>
<p>At this point it seems worthwhile to write a <tt class="docutils literal">learn</tt> function to
pre-compute whatever datastructures we need at estimation&nbsp;time.</p>
<div class="highlight"><pre><span id="line-1"><span class="k">class</span> <span class="nc">CollabGenderReco</span><span class="p">:</span>
</span><span id="line-2">    <span class="sd">&quot;&quot;&quot; Collaborative filtering using an implicit sim(u,u&#39;). &quot;&quot;&quot;</span>
</span><span id="line-3">
</span><span id="line-4">    <span class="k">def</span> <span class="nf">learn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-5">        <span class="sd">&quot;&quot;&quot; Prepare datastructures for estimation. &quot;&quot;&quot;</span>
</span><span id="line-6">
</span><span id="line-7">        <span class="bp">self</span><span class="o">.</span><span class="n">means_by_gender</span> <span class="o">=</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s">&#39;rating&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s">&#39;movie_id&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s">&#39;gender&#39;</span><span class="p">)</span>
</span><span id="line-8">
</span><span id="line-9">    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">):</span>
</span><span id="line-10">        <span class="sd">&quot;&quot;&quot; Mean ratings by other users of the same gender. &quot;&quot;&quot;</span>
</span><span id="line-11">
</span><span id="line-12">        <span class="k">if</span> <span class="n">movie_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">means_by_gender</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
</span><span id="line-13">            <span class="k">return</span> <span class="mf">3.0</span>
</span><span id="line-14">
</span><span id="line-15">        <span class="n">user_gender</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">user_id</span><span class="p">,</span> <span class="s">&#39;gender&#39;</span><span class="p">]</span>
</span><span id="line-16">        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">means_by_gender</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">movie_id</span><span class="p">,</span> <span class="n">user_gender</span><span class="p">]):</span>
</span><span id="line-17">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">means_by_gender</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">movie_id</span><span class="p">,</span> <span class="n">user_gender</span><span class="p">]</span>
</span><span id="line-18">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-19">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">means_by_gender</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">movie_id</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="line-20">
</span><span id="line-21"><span class="n">reco</span> <span class="o">=</span> <span class="n">CollabGenderReco</span><span class="p">()</span>
</span><span id="line-22"><span class="n">reco</span><span class="o">.</span><span class="n">learn</span><span class="p">()</span>
</span><span id="line-23"><span class="k">print</span> <span class="s">&#39;RMSE for CollabGenderReco: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">reco</span><span class="o">.</span><span class="n">estimate</span><span class="p">)</span>
</span></pre></div>
<div class="section" id="mini-challenge">
<h3>Mini-Challenge!</h3>
<ul class="simple">
<li>Not a real&nbsp;challenge</li>
<li>Focus on understanding the different versions of our minimal&nbsp;reco</li>
<li>Try to mix and match some of the ideas presented to come up with a
minimal reco of your&nbsp;own</li>
<li>Evaluate&nbsp;it!</li>
</ul>
</div>
</div>
<div class="section" id="mini-challenge-first-round">
<h2>Mini-Challenge: first&nbsp;round</h2>
<p>Implement an <tt class="docutils literal">estimate</tt> function of your own using other similarity
notions,&nbsp;eg.:</p>
<ul class="simple">
<li>collaborative filter based on age&nbsp;similarities</li>
<li>collaborative filter based on zip code&nbsp;similarities</li>
<li>collaborative filter based on occupation&nbsp;similarities</li>
<li>content filter based on movie&nbsp;genre</li>
</ul>
<div class="section" id="minimal-reco-engine-v1-2-custom-similarity-functions">
<h3>Minimal reco engine v1.2: custom similarity&nbsp;functions</h3>
</div>
</div>
<div class="section" id="a-few-similarity-functions">
<h2>A few similarity&nbsp;functions</h2>
<p>These were all written to operate on two pandas Series, each one
representing the rating history of two different users. You can also
apply them to any two feature vectors that describe users or items. In
all cases, the higher the return value, the more similar two Series are.
You might need to add checks for edge cases, such as divisions by zero,&nbsp;etc.</p>
<ul class="simple">
<li>Euclidean&nbsp;&#8216;similarity&#8217;</li>
</ul>
<div class="math">
\begin{equation*}
sim(x,y) = \frac{1}{1 + \sqrt{\sum (x - y)^2}}
\end{equation*}
</div>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">euclidean</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
</span><span id="line-2">    <span class="sd">&quot;&quot;&quot;Take two pd.Series objects and return their euclidean &#39;similarity&#39;.&quot;&quot;&quot;</span>
</span><span id="line-3">    <span class="n">diff</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">-</span> <span class="n">s2</span>
</span><span id="line-4">    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>
</span></pre></div>
<ul class="simple">
<li>Cosine&nbsp;similarity</li>
</ul>
<div class="math">
\begin{equation*}
sim(x,y) = \frac{(x . y)}{\sqrt{(x . x) (y . y)}}
\end{equation*}
</div>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">cosine</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
</span><span id="line-2">    <span class="sd">&quot;&quot;&quot;Take two pd.Series objects and return their cosine similarity.&quot;&quot;&quot;</span>
</span><span id="line-3">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s1</span> <span class="o">*</span> <span class="n">s2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</span></pre></div>
<ul class="simple">
<li>Pearson&nbsp;correlation</li>
</ul>
<div class="math">
\begin{equation*}
sim(x,y) = \frac{(x - \bar x).(y - \bar y)}{\sqrt{(x - \bar x).(x - \bar x) * (y - \bar y)(y - \bar y)}}
\end{equation*}
</div>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">pearson</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
</span><span id="line-2">    <span class="sd">&quot;&quot;&quot;Take two pd.Series objects and return a pearson correlation.&quot;&quot;&quot;</span>
</span><span id="line-3">    <span class="n">s1_c</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">-</span> <span class="n">s1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="line-4">    <span class="n">s2_c</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">-</span> <span class="n">s2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="line-5">    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s1_c</span> <span class="o">*</span> <span class="n">s2_c</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s1_c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s2_c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</span></pre></div>
<ul class="simple">
<li>Jaccard&nbsp;similarity</li>
</ul>
<div class="math">
\begin{equation*}
sim(x,y) = \frac{(x . y)}{(x . x) + (y . y) - (x . y)}
\end{equation*}
</div>
<div class="highlight"><pre><span id="line-1"><span class="k">def</span> <span class="nf">jaccard</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
</span><span id="line-2">    <span class="n">dotp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s1</span> <span class="o">*</span> <span class="n">s2</span><span class="p">)</span>
</span><span id="line-3">    <span class="k">return</span> <span class="n">dotp</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">dotp</span><span class="p">)</span>
</span><span id="line-4">
</span><span id="line-5"><span class="k">def</span> <span class="nf">binjaccard</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
</span><span id="line-6">    <span class="n">dotp</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">index</span> <span class="o">&amp;</span> <span class="n">s2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
</span><span id="line-7">    <span class="k">return</span> <span class="n">dotp</span> <span class="o">/</span> <span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">s2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">dotp</span><span class="p">)</span>
</span></pre></div>
</div>
<div class="section" id="collaborative-based-filtering-using-custom-sim-functions">
<h2>Collaborative-based filtering using custom sim&nbsp;functions</h2>
<div class="highlight"><pre><span id="line-1"><span class="k">class</span> <span class="nc">CollabPearsonReco</span><span class="p">:</span>
</span><span id="line-2">    <span class="sd">&quot;&quot;&quot; Collaborative filtering using a custom sim(u,u&#39;). &quot;&quot;&quot;</span>
</span><span id="line-3">
</span><span id="line-4">    <span class="k">def</span> <span class="nf">learn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-5">        <span class="sd">&quot;&quot;&quot; Prepare datastructures for estimation. &quot;&quot;&quot;</span>
</span><span id="line-6">
</span><span id="line-7">        <span class="bp">self</span><span class="o">.</span><span class="n">all_user_profiles</span> <span class="o">=</span> <span class="n">movielens</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s">&#39;rating&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s">&#39;movie_id&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s">&#39;user_id&#39;</span><span class="p">)</span>
</span><span id="line-8">
</span><span id="line-9">    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">):</span>
</span><span id="line-10">        <span class="sd">&quot;&quot;&quot; Ratings weighted by correlation similarity. &quot;&quot;&quot;</span>
</span><span id="line-11">
</span><span id="line-12">        <span class="n">user_condition</span> <span class="o">=</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">user_id</span>
</span><span id="line-13">        <span class="n">movie_condition</span> <span class="o">=</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">movie_id</span> <span class="o">==</span> <span class="n">movie_id</span>
</span><span id="line-14">        <span class="n">ratings_by_others</span> <span class="o">=</span> <span class="n">movielens_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">user_condition</span> <span class="o">&amp;</span> <span class="n">movie_condition</span><span class="p">]</span>
</span><span id="line-15">        <span class="k">if</span> <span class="n">ratings_by_others</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="line-16">            <span class="k">return</span> <span class="mf">3.0</span>
</span><span id="line-17">
</span><span id="line-18">        <span class="n">ratings_by_others</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span id="line-19">        <span class="n">their_ids</span> <span class="o">=</span> <span class="n">ratings_by_others</span><span class="o">.</span><span class="n">index</span>
</span><span id="line-20">        <span class="n">their_ratings</span> <span class="o">=</span> <span class="n">ratings_by_others</span><span class="o">.</span><span class="n">rating</span>
</span><span id="line-21">        <span class="n">their_profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_user_profiles</span><span class="p">[</span><span class="n">their_ids</span><span class="p">]</span>
</span><span id="line-22">        <span class="n">user_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_user_profiles</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>
</span><span id="line-23">        <span class="n">sims</span> <span class="o">=</span> <span class="n">their_profiles</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">profile</span><span class="p">:</span> <span class="n">pearson</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">user_profile</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="line-24">        <span class="n">ratings_sims</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">&#39;sim&#39;</span><span class="p">:</span> <span class="n">sims</span><span class="p">,</span> <span class="s">&#39;rating&#39;</span><span class="p">:</span> <span class="n">their_ratings</span><span class="p">})</span>
</span><span id="line-25">        <span class="n">ratings_sims</span> <span class="o">=</span> <span class="n">ratings_sims</span><span class="p">[</span><span class="n">ratings_sims</span><span class="o">.</span><span class="n">sim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="line-26">        <span class="k">if</span> <span class="n">ratings_sims</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="line-27">            <span class="k">return</span> <span class="n">their_ratings</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="line-28">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-29">            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">ratings_sims</span><span class="o">.</span><span class="n">rating</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">ratings_sims</span><span class="o">.</span><span class="n">sim</span><span class="p">)</span>
</span><span id="line-30">
</span><span id="line-31"><span class="n">reco</span> <span class="o">=</span> <span class="n">CollabPearsonReco</span><span class="p">()</span>
</span><span id="line-32"><span class="n">reco</span><span class="o">.</span><span class="n">learn</span><span class="p">()</span>
</span><span id="line-33"><span class="k">print</span> <span class="s">&#39;RMSE for CollabPearsonReco: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">reco</span><span class="o">.</span><span class="n">estimate</span><span class="p">)</span>
</span></pre></div>
</div>
<div class="section" id="mini-challenge-second-round">
<h2>Mini-Challenge: second&nbsp;round</h2>
<p>Implement an <tt class="docutils literal">estimate</tt> function of your own using other custom
similarity notions,&nbsp;eg.:</p>
<ul class="simple">
<li>euclidean</li>
<li>cosine</li>
</ul>
<div class="section" id="references-and-further-reading">
<h3>References and further&nbsp;reading</h3>
<ul class="simple">
<li>Goldberg, D., D. Nichols, <span class="caps">B. M.</span> Oki, and D. Terry. “Using
Collaborative Filtering to Weave an Information Tapestry.”
Communications of the <span class="caps">ACM</span> 35, no. 12 (1992):&nbsp;61–70.</li>
<li>Resnick, Paul, and Hal R. Varian. “Recommender Systems.” Commun. <span class="caps">ACM</span>
40, no. 3 (March 1997): 56–58.&nbsp;doi:10.1145/245108.245121.</li>
<li>Adomavicius, Gediminas, and Alexander Tuzhilin. “Toward the Next
Generation of Recommender Systems: A Survey of the State-of-the-Art
and Possible Extensions.” <span class="caps">IEEE</span> Transactions on Knowledge and Data
Engineering 17, no. 6 (2005): 734–749.
doi:http://doi.ieeecomputersociety.org/10.1109/<span class="caps">TKDE</span>.2005.99.</li>
<li>Adomavicius, Gediminas, Ramesh Sankaranarayanan, Shahana Sen, and
Alexander Tuzhilin. “Incorporating Contextual Information in
Recommender Systems Using a Multidimensional Approach.” <span class="caps">ACM</span> Trans.
Inf. Syst. 23, no. 1 (2005): 103–145.&nbsp;doi:10.1145/1055709.1055714.</li>
<li>Koren, Y., R. Bell, and C. Volinsky. “Matrix Factorization Techniques
for Recommender Systems.” Computer 42, no. 8 (2009):&nbsp;30–37.</li>
<li>William Wesley McKinney. Python for Data Analysis. O’Reilly,&nbsp;2012.</li>
<li>Toby Segaran. Programming Collective Intelligence. O’Reilly,&nbsp;2007.</li>
<li>Zhou, Tao, Zoltan Kuscsik, Jian-Guo Liu, Matus Medo, Joseph R
Wakeling, and Yi-Cheng Zhang. “Solving the Apparent
Diversity-accuracy Dilemma of Recommender Systems.” arXiv:0808.2670
(August 19, 2008).&nbsp;doi:10.1073/pnas.1000488107.</li>
<li>Shani, G., D. Heckerman, and R. I Brafman. “An <span class="caps">MDP</span>-based Recommender
System.” Journal of Machine Learning Research 6, no. 2 (2006):&nbsp;1265.</li>
<li>Joseph A. Konstan, John Riedl. &quot;Deconstructing Recommender Systems.&quot;
<span class="caps">IEEE</span> Spectrum, October&nbsp;2012.</li>
</ul>
</div>
</div>
<script type='text/javascript'>if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }
    
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: false," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'sanghan'; // required: replace example with your forum shortname

                    var disqus_identifier = 'recommendation_engine';
                var disqus_url = 'http://sanghan.me/blog/2015/05/recommendation_engine/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="http://github.com/jjangsangy"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                <li class="list-group-item"><a href="http://facebook.com/jjangsangy"><i class="fa fa-facebook-square fa-lg"></i> Facebook</a></li>
                <li class="list-group-item"><a href="https://twitter.com/jjangsangy"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
                <li class="list-group-item"><a href="https://www.linkedin.com/pub/sang-han/40/9a8/323"><i class="fa fa-linkedin-square fa-lg"></i> LinkedIn</a></li>
                <li class="list-group-item"><a href="http://jjangsangy.tumblr.com"><i class="fa fa-tumblr-square fa-lg"></i> Tumblr</a></li>
                <li class="list-group-item"><a href="http://pinterest.com/jjangsangy"><i class="fa fa-pinterest-square fa-lg"></i> Pinterest</a></li>
              </ul>
            </li>

            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                <ul class="list-group" id="recentposts">
                    <li class="list-group-item">
                        <a href="http://sanghan.me/blog/2015/06/visualizaitions/">
                            Data Visualization by Programming&nbsp;Language
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://sanghan.me/blog/2015/05/recommendation_engine/">
                            The Anatomy of a Recommendation&nbsp;Engine
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://sanghan.me/blog/2015/03/machine_learning_notes/">
                            Machine Learning&nbsp;Notes
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://sanghan.me/blog/2014/12/python_tricks/">
                            Useful Python&nbsp;Tricks
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="http://sanghan.me/blog/2014/09/sieve/">
                            Prime Sieves and Python Data&nbsp;Structures
                        </a>
                    </li>
                </ul>
            </li>



    <li class="list-group-item"><h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/jjangsangy">@jjangsangy</a> on GitHub
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 LightQuanta
            &middot; Sang Han         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://sanghan.me/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://sanghan.me/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://sanghan.me/theme/js/respond.min.js"></script>
<script src="http://sanghan.me/static/js/headroom.min.js"></script>
<script src="http://sanghan.me/static/js/site.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'http://sanghan.me/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'jjangsangy',
                count: 10,
                skip_forks: true,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="http://sanghan.me/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'sanghan'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-51412306-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>